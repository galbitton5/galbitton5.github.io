<script src="{{ base_path }}/assets/js/main.min.js"></script>

{% include analytics.html %}
{% include /comments-providers/scripts.html %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. Get references to our dropdown elements
    const themeButton = document.getElementById("theme-button");
    const themeMenu = document.getElementById("theme-menu");
    const themeOptions = document.querySelectorAll(".theme-option");

    // 2. Load saved theme or default to "dark"
    //    (Change "dark" to "auto" or "light" if you prefer a different default)
    let savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);

    // 3. Toggle dropdown menu visibility when clicking the theme button
    if (themeButton && themeMenu) {
      themeButton.addEventListener("click", function() {
        themeMenu.classList.toggle("hidden");
      });
    } else {
      console.warn("Theme button or menu not found. Check your HTML IDs (theme-button, theme-menu).");
    }

    // 4. Handle theme selection from the dropdown
    themeOptions.forEach(option => {
      option.addEventListener("click", function() {
        const chosenTheme = this.getAttribute("data-theme");
        setTheme(chosenTheme);
        localStorage.setItem("theme", chosenTheme);
        // Hide the dropdown after selection
        themeMenu.classList.add("hidden");
      });
    });

    // ------------------ Theme Functions ------------------ //

    // Main function to apply theme
    function setTheme(mode) {
      if (mode === "light") {
        document.body.classList.remove("dark-mode");
        removeSystemListener();
      } else if (mode === "dark") {
        document.body.classList.add("dark-mode");
        removeSystemListener();
      } else {
        // "auto" => follow system (OS) preference
        watchSystemTheme();
      }
    }

    // Watch system preference for "auto" mode
    let mediaQuery;
    function watchSystemTheme() {
      mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
      applySystemTheme(mediaQuery.matches);
      mediaQuery.addEventListener("change", onSystemThemeChange);
    }

    function onSystemThemeChange(e) {
      applySystemTheme(e.matches);
    }

    function applySystemTheme(isDark) {
      if (isDark) {
        document.body.classList.add("dark-mode");
      } else {
        document.body.classList.remove("dark-mode");
      }
    }

    // Remove system listener if user chooses light or dark explicitly
    function removeSystemListener() {
      if (mediaQuery) {
        mediaQuery.removeEventListener("change", onSystemThemeChange);
      }
    }
  });
</script>
